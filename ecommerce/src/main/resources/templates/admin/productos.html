<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>Administración de Productos</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
</head>
<body class="bg-light">
<nav th:replace="index :: nav"></nav>

<main class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Administración de Productos</h2>
        <a th:href="@{/admin/productos/nuevo}" class="btn btn-success">
            Nuevo Producto
        </a>
    </div>

    <div id="productos-container" class="row row-cols-1 row-cols-md-3 g-4">
        <!-- Los productos se cargarán dinámicamente via JS -->
    </div>
</main>

<script>
    // Obtener token JWT de las cookies
    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
    }

    // Configurar Axios para enviar el token
    axios.defaults.headers.common['Authorization'] = `Bearer ${getCookie('JWT')}`;

    // Cargar productos al iniciar
    axios.get('/api/productos')
        .then(response => {
            const container = document.getElementById('productos-container');
            response.data.forEach(producto => {
                container.innerHTML += `
                        <div class="col">
                            <div class="card h-100 shadow">
                                <div class="card-body">
                                    <h5 class="card-title">${producto.nombre}</h5>
                                    <p class="card-text">${producto.descripcion || 'Sin descripción'}</p>
                                    <p class="text-muted">€ ${producto.precio.toFixed(2)}</p>
                                    <p>Stock: ${producto.stock}</p>
                                    <div class="d-grid gap-2">
                                        <a href="/admin/productos/editar/${producto.idProducto}"
                                           class="btn btn-primary">Editar</a>
                                        <button class="btn btn-danger"
                                                onclick="eliminarProducto(${producto.idProducto})">Eliminar</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
            });
        })
        .catch(error => {
            if(error.response.status === 403) {
                window.location.href = '/login';
            }
        });

    function eliminarProducto(id) {
        if(confirm('¿Estás seguro de eliminar este producto?')) {
            axios.delete(`/api/productos/${id}`)
                .then(() => window.location.reload())
                .catch(error => {
                    if(error.response.status === 403) {
                        alert('No tienes permisos para esta acción');
                    }
                });
        }
    }
</script>
</body>
</html>