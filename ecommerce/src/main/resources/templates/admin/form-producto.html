<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${producto?.idProducto} ? 'Editar Producto' : 'Nuevo Producto'"></title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
        .form-error {
            color: #dc3545;
            font-size: 0.875em;
            margin-top: 0.25rem;
        }
        .required-label:after {
            content: "*";
            color: #dc3545;
            margin-left: 0.25rem;
        }
    </style>
</head>
<body class="bg-light">
<nav th:replace="index :: nav"></nav>

<main class="container mt-5">
    <div class="card shadow">
        <div class="card-body">
            <h2 class="mb-4" th:text="${producto?.idProducto} ? 'Editar Producto' : 'Nuevo Producto'"></h2>

            <form id="productoForm" novalidate>
                <input type="hidden" id="idProducto" th:value="${producto?.idProducto}">

                <!-- Nombre -->
                <div class="mb-3">
                    <label class="form-label required-label">Nombre</label>
                    <input type="text" class="form-control" id="nombre"
                           required maxlength="100"
                           pattern="[A-Za-zÁ-Úá-ú0-9\s]{3,}">
                    <div class="form-error" id="nombreError"></div>
                </div>

                <!-- Descripción -->
                <div class="mb-3">
                    <label class="form-label">Descripción</label>
                    <textarea class="form-control" id="descripcion"
                              rows="3" maxlength="255"></textarea>
                    <div class="form-error" id="descripcionError"></div>
                </div>

                <!-- Precio y Stock -->
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label required-label">Precio (€)</label>
                        <input type="number" class="form-control" id="precio"
                               step="0.01" min="0" required>
                        <div class="form-error" id="precioError"></div>
                    </div>

                    <div class="col-md-6 mb-3">
                        <label class="form-label required-label">Stock</label>
                        <input type="number" class="form-control" id="stock"
                               min="0" required>
                        <div class="form-error" id="stockError"></div>
                    </div>
                </div>

                <!-- Botones -->
                <div class="d-flex justify-content-end gap-2">
                    <a th:href="@{/admin/productos}" class="btn btn-secondary">Cancelar</a>
                    <button type="submit" class="btn btn-primary">
                        <span th:text="${producto?.idProducto} ? 'Guardar' : 'Crear'"></span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</main>

<script>
    // Configurar Axios con JWT
    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
    }

    axios.defaults.headers.common['Authorization'] = `Bearer ${getCookie('JWT')}`;

    // Validaciones en tiempo real
    function validateField(input, errorId, validationFn) {
        const errorElement = document.getElementById(errorId);
        input.classList.remove('is-invalid');
        errorElement.textContent = '';

        if (!validationFn(input.value)) {
            input.classList.add('is-invalid');
            return false;
        }
        return true;
    }

    // Validaciones según entidad Producto
    const validations = {
        nombre: value => /^[A-Za-zÁ-Úá-ú0-9\s]{3,}$/.test(value.trim()),
        precio: value => parseFloat(value) >= 0,
        stock: value => parseInt(value) >= 0,
        descripcion: value => value.length <= 255
    };

    // Manejar envío del formulario
    document.getElementById('productoForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        let isValid = true;
        const fields = {
            nombre: document.getElementById('nombre'),
            precio: document.getElementById('precio'),
            stock: document.getElementById('stock'),
            descripcion: document.getElementById('descripcion')
        };

        // Validar campos
        isValid &= validateField(fields.nombre, 'nombreError', validations.nombre);
        isValid &= validateField(fields.precio, 'precioError', validations.precio);
        isValid &= validateField(fields.stock, 'stockError', validations.stock);
        isValid &= validateField(fields.descripcion, 'descripcionError', validations.descripcion);

        if (!isValid) return;

        const productoData = {
            nombre: fields.nombre.value.trim(),
            descripcion: fields.descripcion.value.trim(),
            precio: parseFloat(fields.precio.value),
            stock: parseInt(fields.stock.value)
        };

        try {
            const id = document.getElementById('idProducto')?.value;
            const url = id ? `/api/productos/${id}` : '/api/productos';
            const method = id ? 'PUT' : 'POST';

            await axios({ method, url, data: productoData });
            window.location.href = '/admin/productos';
        } catch (error) {
            if (error.response) {
                const { status, data } = error.response;

                if (status === 400) {
                    // Manejar errores del servidor
                    data.forEach(err => {
                        const field = err.field.toLowerCase();
                        if (fields[field]) {
                            fields[field].classList.add('is-invalid');
                            document.getElementById(`${field}Error`).textContent = err.message;
                        }
                    });
                } else if (status === 403) {
                    alert('No tienes permisos para realizar esta acción');
                    window.location.href = '/login';
                }
            }
        }
    });

    // Cargar datos si es edición
    const id = document.getElementById('idProducto')?.value;
    if (id) {
        axios.get(`/api/productos/${id}`)
            .then(response => {
                const producto = response.data;
                document.getElementById('nombre').value = producto.nombre;
                document.getElementById('descripcion').value = producto.descripcion || '';
                document.getElementById('precio').value = producto.precio;
                document.getElementById('stock').value = producto.stock;
            })
            .catch(error => {
                if (error.response.status === 403) {
                    window.location.href = '/login';
                }
            });
    }

    // Validación en tiempo real
    document.querySelectorAll('input, textarea').forEach(input => {
        input.addEventListener('input', () => {
            const field = input.id;
            if (validations[field]) {
                validateField(input, `${field}Error`, validations[field]);
            }
        });
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>